<template>
  <div id="yhkgl">
    <div class="yhkgl_main" v-show="!showBind">
      <div class="yhkgl_top">
        <div class="add_title">
          <img src="../../assets/grsy/addbankcard.png" @click="addBankCart" alt="">
          <a @click="addBankCart">添加银行卡</a>
        </div>
        <div class="wxts_text">
          <p class="wxts">温馨提示：</p>
          <p class="list">1、银行卡的开户名必须和实名认证的一致。</p>
          <p class="list">2、最多只能添加10张银行卡。</p>
          <p class="list">3、如需修改或删除银行卡账号请联系客服人员。</p>
        </div>
      </div>

      <div class="czTable">
        <el-table
          :data="tableData"
          border
          style="width: 100%">
          <el-table-column
            prop="BankName"
            label="开户银行"
            width="120">
          </el-table-column>
          <el-table-column
            prop="NickName"
            label="姓名"
            width="60">
          </el-table-column>
          <el-table-column
            prop="BankNumber"
            label="银行卡号"
          >
          </el-table-column>
          <el-table-column
            prop="address"
            label="地址">
          </el-table-column>
          <el-table-column
            prop="BankBranch"
            label="支行名称"
            width="130">
          </el-table-column>
          <el-table-column
            prop="CreateTime"
            label="日期"
            width="144">
          </el-table-column>


        </el-table>
      </div>

      <!-- 判断有没有银行卡的时候 显示 -->
      <div class="none_card" v-show="!isBind">
        <span style="color:#acacac">您暂未绑定银行卡，点击</span>
        <span class="blue" @click="addBankCart">添加银行卡</span>
      </div>
      <div class="bottom" v-if="isBind" v-show="bindTipsShow">
        <div class="bottom_top">
          <div class="tips_bind"></div>
          <p class="bottom_ts_text">{{bindTips}}</p>
          <span class="blue" v-if="tableData.length<10" @click="addBankCart">添加银行卡</span>
        </div>
        <i class="el-icon-close oranges" @click="bindTipsShow = false"></i>
      </div>
    </div>
    <!-- 绑定银行卡 -->
    <div class="bindCart" v-show="showBind">
      <el-form ref="form" :model="form" label-width="150px">
        <el-form-item label="开户银行">
          <el-select v-model="form.Bid" placeholder="请选择">
            <el-option
              v-for="item in bankInfo"
              :key="item.Bid"
              :label="item.Name"
              :value="item.Bid">
            </el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="开户人">
          <el-input v-model="userInfo.FullName" :disabled="true"></el-input>
        </el-form-item>
        <el-form-item label="开户地址">
          <el-select v-model="form.BankProvince" placeholder="请选择" @change="chooseProvince">
            <el-option
              v-for="item in provinceInfo"
              :key="item.Value"
              :label="item.Name"
              :value="item.Value">
            </el-option>
          </el-select>
          <!-- 市 -->
          <el-select v-model="form.BankCity" placeholder="请选择" style="margin-top: 10px;">
            <el-option
              v-for="item in cityInfo"
              :key="item.Value"
              :label="item.Name"
              :value="item.Value">
            </el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="银行卡号">
          <el-input v-model="form.BankNumber"></el-input>
        </el-form-item>
        <el-form-item label="支行名称">
          <el-input v-model="form.BankBranch"></el-input>
        </el-form-item>
        <el-form-item>
          <el-button type="primary btn_color" @click="onSubmit">立即创建</el-button>
          <el-button @click="onCancel">取消</el-button>
        </el-form-item>
      </el-form>

    </div>
    <!-- 完善姓名 -->
    <el-dialog title="提示" :visible.sync="dialogVisible" width="30%">
      <div class="warning_img">
        <img src="../../assets/img/icon/window/warring.png" style="width: 54px;height: 52px;">
      </div>
      <div style="text-align: center;">您尚未设置真实姓名，请设置</div>
      <span slot="footer" class="dialog-footer">
		    <el-button class="pop_sure_btn" type="primary" @click="goBindCart">确 定</el-button>
		  </span>
    </el-dialog>
  </div>
</template>

<script>
    // 引用axios封装文件
    import {postAjax, getAjax} from "../../util/ajax.js";
    import {Message} from 'element-ui';

    export default {
        name: 'yhkgl',
        data() {
            return {
                bindTipsShow: true,
                dialogVisible: false,
                input: '',
                tableData: [],
                //隐藏或显示绑定一张卡还是为绑定卡
                isBind: false,
                //银行列表信息
                bankInfo: [],
                //省份信息
                provinceInfo: [],
                //市信息
                cityInfo: [],
                //显示隐藏绑定银行卡
                showBind: false,
                form: {
                    Bid: '',
                    BankProvince: '',
                    BankCity: '',
                    BankNumber: '',
                    BankBranch: ''
                },
                userInfo: '',
            }
        },
        computed: {
            bindTips() {
                return `您已经绑定${this.tableData.length}张银行卡`
            },
        },
        methods: {
            changesBtnGRSY(type) {
                console.log(type)
                let changemima = null;
            },
            //时间格式化
            formatDate(row, column) {
                return row[column.property]
                if (row[column.property]) {
                    var arr = row[column.property].split("T");
                    var arr1 = arr[1].split(".")
                    return arr[0] + ' ' + arr1[0]
                } else {
                    return '-'
                }
            },
            //获取绑定银行卡接口
            getBankList() {
                var that = this;
                var url = "api/Bank/GetUserBankList";
                getAjax(url).then(function (data) {
                    if (data.IsSucess) {
                        that.tableData = data.Data;
                        //如果有数据就给他增加一个字段为地址address
                        if (that.tableData.length > 0) {
                            that.isBind = true;
                            for (var i = 0, length = that.tableData.length; i < length; i++) {
                                that.tableData[i].address = that.tableData[i].BankProvince + '--' + that.tableData[i].BankCity;
                            }
                        } else {
                            that.isBind = false;
                        }
                    }
                })
            },
            //获取银行列表
            getBankInfo() {
                var that = this;
                var url = "api/Bank/GetBankListInfo";
                getAjax(url).then(function (data) {
                    if (data.IsSucess) {
                        that.bankInfo = data.Data;
                    }
                })
            },
            //获取省份信息
            getProvinceInfo() {
                var that = this;
                var url = "api/Sys/GetProvince";
                postAjax(url, null).then(function (data) {
                    if (data.IsSucess) {
                        that.provinceInfo = data.Data;
                    }
                })
            },
            //添加银行卡
            addBankCart() {
                if (this.tableData.length > 9) {
                    this.$message.error('最多只能添加10张银行卡')
                    return
                }
                if (!this.userInfo.FullName) {
                    this.dialogVisible = true;
                } else {
                    this.showBind = true;
                }
            },
            // 得到用户信息方法
            getUserInfo() {
                let that = this;
                let url = "Api/User/GetUserInfo";
                postAjax(url, null)
                    .then(function (data) {
                        console.log(data);
                        if (data.IsSucess) {
                            that.userInfo = data.Data;
                            if (!that.userInfo.FullName) {
                                that.dialogVisible = true;
                            }
                        }
                    })
            },
            //选择省份显示市级信息
            chooseProvince(val) {
                this.form.BankCity = '';
                let that = this;
                let url = "/api/Sys/GetCitys?Province=" + val;
                postAjax(url, null).then(function (data) {
                    if (data.IsSucess) {
                        that.cityInfo = data.Data;
                    }
                })
            },
            //立即创建
            onSubmit() {
                let res = this.checkCardNum()
                if (res != true) {
                    Message.error(res)
                    return
                }

                let that = this;
                let url = '/api/Bank/AddUserBankInfo';
                postAjax(url, this.form).then(function (data) {
                    if (data.IsSucess) {
                        that.getBankList();
                        that.onCancel()
                    } else {
                        that.$message.error(data.Message)
                    }
                })
            },
            onCancel() {
                this.showBind = false;
                this.form = {
                    Bid: '',
                    BankProvince: '',
                    BankCity: '',
                    BankNumber: '',
                    BankBranch: ''
                };
            },
            checkCardNum() {
                let bankno = this.form.BankNumber
                let num = /^\d*$/; //全数字
                let strBin =
                    "10,18,30,35,37,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,58,60,62,65,68,69,84,87,88,94,95,98,99"; //开头6位
                if (bankno == "") {
                    return '请输入银行卡号'
                } else if (bankno.length < 16 || bankno.length > 19) {
                    return '银行卡号长度必须在16到19之间'
                } else if (!num.exec(bankno)) {
                    return '银行卡号必须全为数字'
                } else if (strBin.indexOf(bankno.substring(0, 2)) == -1) {
                    return '银行卡号开头6位不符合规范'
                } else {
                    return true
                }
            },
            //时间格式化
            formatDate(row, column) {
                if (row[column.property]) {
                    var arr = row[column.property].split("T");
                    var arr1 = arr[1].split(".")
                    return arr[0] + ' ' + arr1[0]
                } else {
                    return '-'
                }
            },
            goBindCart() {
                this.$emit('gobingrzl', '1')
                this.dialogVisible = false;
            }
        },
        mounted() {
            this.getBankList();
            this.getBankInfo();
            this.getProvinceInfo();
            this.getUserInfo();
        }
    }
</script>

<style lang="scss" scoped>
  #yhkgl {
    height: 100%;
    padding: 13px 22px 0;

    .yhkgl_main{

      .yhkgl_top {
        display: flex;
        justify-content: center;
        width: 100%;
        height: 150px;
        position: relative;

        .add_title{
          width: 204px;
          height: 130px;
          margin-top: 10px;

          img {
            display: block;
            width: 72px;
            height: 70px;
            margin: 10px auto 0;
            cursor: pointer;
          }

          a{
            display: block;
            width: 106px;
            height: 28px;
            margin: 13px auto 0;
            background-color: #008573;
            font-size: 12px;
            color: #ffffff;
            text-align: center;
            line-height: 28px;
            border-radius: 14px;
            cursor: pointer;
          }
        }

        .wxts_text {
          display: flex;
          flex-direction: column;
          justify-content: space-around;
          height: 116px;
          width: 100%;
          padding-top: 10px;
          padding-left: 20px;

          .wxts {
            font-size: 14px;
            font-weight: bold;
          }

          .list {
            font-size: 14px;
            color: #9c9c9c;
            line-height: 16px;
          }
        }
      }

      .none_card {
        text-align: center;
        font-size: 14px;
        color: #666;
        margin-top: 20px;       
      }

      .bottom {
        height: 50px;
        background: #fefbed;
        border: 1px solid #f1a104;
        margin: 20px 35px 0 35px;
        display: flex;
        align-items: center;
        justify-content: space-between;

        .bottom_top {
          display: flex;
          align-items: center;

          .tips_bind {
            width: 22px;
            height: 22px;
            margin-left: 20px;
            background-image: url("../../assets/grsy/tips.png");
            background-size: 100% 100%;
          }

          .blue {
            margin-left: 10px;
            font-size: 14px;
          }

          .bottom_ts_text {
            color: #d5a54a;
            font-size: 14px;
            font-weight: bold;
            margin-left: 15px;
          }
        }

        .el-icon-close{
          cursor: pointer;
        }
      }

      .blue {
        color: blue;
        text-decoration: underline;
        cursor: pointer;
      }

      .oranges {
        color: #f1a104;
        font-size: 22px;
        margin-right: 20px;
      }

      .boranges {
        color: #c29328
      }

    }

    .bindCart {
      width: 600px;
      margin: auto;
      margin-top: 20px;
      padding: 30px 100px 10px 0;
      box-shadow: 0px 2px 16px 0px rgba(53, 63, 75, 0.1);
      border-radius: 5px;

      .el-form{

        .el-select {
          width: 100%;
        }

        .el-button{
          width:96px;

          &.el-button--default{
            margin-left: 20px;

            &:hover{
              border: 1px solid #DCDFE6;
              background: #fff;
              color: #606266;
            }
          }
        }

        .btn_color {
          background-color: #2ba498;
          border: 0;
        }
      }
    }

    /deep/ .el-dialog{

      .el-dialog__header {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;

        .el-dialog__title{
          color: #fff;
        }
      }

      .el-dialog__body {
        padding: 0;

        .warning_img {
          margin: 34px 0 28px;
          text-align: center;
        }
      }

      .el-dialog__footer {
        padding: 50px 0 25px;
        text-align: center;

        .pop_sure_btn {
          color: #fff;
          background-color: #2ba498;
          border-color: #2ba498;
          width: 120px;
        }
      }
    }
  }
</style>